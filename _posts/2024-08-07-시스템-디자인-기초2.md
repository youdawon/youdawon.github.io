---
layout: post
date: 2024-08-07
title: "시스템 디자인 기초2"
tags: [systemdesign, architecture, ]
categories: [systemDesign, basics, ]
---


---


### 


처리율 제한 장치는 클라이언트 또는 서비스가 보내는 트래픽의 처리율을 제어하기 위한 장치이다. 추가 요청에 대한 처리를 제한하면 서버를 많이 두지 않아도 되고 우선순위가 높은 API에 더 많은 자원을 할당할 수 있다.


처리율 제한 장치는 클라이언트도 둘 수 있지만 위변조가 가능하기 때문에 모든 클라이언트의 구현을 통제하는 것이 어렵다. 서버 측에 둔다면 서버에 직접 처리할 수 있지만 중간에 처리율 제한 장치를 둠으로써 통제가 가능하다.


클라우드 마이크로서비스의 경우 처리율 제한 장치는 보통 **API 게이트웨이**라는 컴포넌트에 의해 구현된다.


### API 게이트웨이

- 처리율 제한
- SSL 종단
- 사용자 인증
- IP 허용목록 관리 등

처리율 제한 장치를 직접 설계할 경우 시간이 많이 들기 때문에 인력이 부족하다면 상용 API 게이트웨이를 사용하는 것이 바람직하다.


### 처리율 제한 알고리즘

- **토큰 버킷 (token bucket)**: 지정된 용량을 갖는 컨테이너이다. 토큰이 꽉 찬 버킷에는 더 이상의 토큰은 추가되지 않는다. 버킷이 가득 차면 추가로 공급된 토큰은 버려진다. 이 알고리즘은 두 개의 인자를 받는다.
	- **버킷 크기**: 버킷에 담을 수 있는 토큰의 최대 개수
	- **토큰 공급률**: 초당 몇 개의 토큰이 버킷에 공급되는가
- **누출 버킷 (leaky bucket)**: 토큰 버킷 알고리즘과 비슷하지만 요청 처리율이 고정되어 있다. FIFO 큐로 구현한다. 요청이 도착하면 큐에 가득 차 있는지 본다. 빈자리가 있는 경우에는 큐에 요청을 추가한다. 큐가 가득 차 있는 경우에는 새 요청은 버린다.
- **고정 윈도 카운터 알고리즘**
- **이동 윈도 로그**
- **이동 윈도 카운터**

난 그냥 API 게이트웨이 쓸래.


### 처리율 제한을 기피하는 법

- 클라이언트 측에 캐시를 이용하며 API 요청 수를 줄인다.
- 짧은 시간 동안 너무 많은 메시지를 보내지 않도록 한다.
- 예외나 에러를 처리하는 코드를 도입한다.
- Retry 로직을 구현할 때는 충분한 back-off 시간을 둔다.
